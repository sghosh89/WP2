---
title: Preliminary report, Effect of climatic extremes on community stability and its drivers
author: "Shyamolina Ghosh, Owen Petchey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    code_folding: hide
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE)
```

```{r echo = FALSE}
#rm(list = ls())
library(broom)
library(tidyverse)
library(patchwork)
library(here)
source(here("R", "mtime.R"))
```

# Introduction

*The following text originally came from the Ghosh UZH UFO application*

As the global climate is experiencing more heat, and less rainfall - it is reasonable to expect that the distributions of these variables (temperature and rainfall) are becoming more skewed and asymmetric towards the extreme values (see figure \@ref(fig:introduction-figure) below, which comes from the UZH UFO proposal, where it was figure 2). With the availability of more open access long-term databases, it is possible to address how different taxa respond at the community level.

```{r introduction-figure, echo=FALSE, fig.cap="Introduction figure", out.width = '50%', fig.align='center'}
#here("Results/some_assets/Intro_figure.png")
knitr::include_graphics(here("Results/some_assets/Intro_figure.png"),
                        rel_path = FALSE)
```


As a preliminary work, I have already gathered long-term (median of 41 years) species-level abundance data for 2043 terrestrial and 716 aquatic communities. My recent result (manuscript in preparation) shows that the community stability is different for terrestrial and freshwater taxa and could be better explained considering the different strengths between pairwise species associations at the extremes, called community-level tail association, than with classic correlates of community stability studies (richness and variance ratio).

I will gather global data for annual temperature and rainfall from open access CHELSA database19 and ask how variability in temperature and precipitation would affect terrestrial taxa (birds, mammals, invertebrates, plants). For freshwater taxa (fish, phytoplankton, invertebrates), mostly temperature variability would be considered. In marine realm, sampling is spatially not consistent over the years20 and also very few long-term (>20yrs) data sampled compared to terrestrial and freshwater, thus I will focus only on the latter two realms. Also, species-level biomass (or body size) data will be gathered considering different generation times across taxa.

I will focus on community stability and will build a Bayesian model incorporating climatic factors (e.g., variability, skewness, range of maximum and minimum of temperature-distribution over the years etc.). While scientists studied thermophilization in the context of warming-related turnover in communities, no predictive model for community stability has been developed, to date, assessing the effect of extreme climatic events across taxa using a global database. This study will inform the current status of communities across multiple taxa facing climatic extremes and help prioritize conservation efforts (see Work Package 2).

I will gather annual climate data (mean, minimum, maximum for temperature, rainfall) and compute the variability, and the skewness of their distribution for the study period over which the community dynamics was studied. I will compute the richness (number of total species and dominant species that were present minimum 70% of the total years sampled), variance ratio, community level total tail association from pairwise synchrony as drivers. These drivers appeared as significant for explaining variation in community stability from my recent study (manuscript in preparation). I will compute the response variable community stability as the inverse of community-variability over the study period. Then, I will build a Bayesian model to see the effect of climate parameters, on the stability-driver relationships for different taxa.

# Data

```{r read_data_str, echo=F}
library(dplyr)
library(tidyverse)

sm_all<-read.csv(here("Results/stability_metric_and_env_all.csv"))
```

## Data structure
Total `r nrow(sm_all)` community timeseries we have collected for the timespan 1979-2019. 4 taxa are considered - birds, fish, freshwater invertebrates, terrestrial invertebrates. Below is the summary of the datatable. Description of each column is given in [README.txt](https://github.com/sghosh89/WP2/tree/main/Results)

```{r str_data, echo=F}
str(sm_all) # total communities within 1979-2019 timespan, we selected only 4 taxa
```

But see the below table which shows the sample size for each taxa and the datasource, we have very few sample size for terrestrial invertebrates. **I feel** it's better to write a paper about north american birds vs european fish (atleast we have >500 datapoints for birds and fish). But I am open to other ideas. I don't know which kind of data requirement we need for response diversity, but if we can have the body size or biomass (as trait) data then I can test the H0: whether response diversity increases the stability or influenced by temperature?
```{r read_data_str2, echo=F}
sm_all%>%group_by(TAXA,source)%>%summarise(n=n())%>%ungroup()
```

## Sitemap for each taxa

```{r sitemap_figure, echo=FALSE, out.width = '100%', fig.align='center'}
library(htmltools)
library(htmlwidgets)
library(leaflet)

taxalist<-c("birds","fish","freshwater invertebrates","terrestrial invertebrates")
sitemaplist<-vector(mode = "list", length = length(taxalist))
#op<-par(mfrow=c(2,2))
for(i in 1:length(taxalist)){
  taxa<-taxalist[i]
  dat<-sm_all%>%filter(TAXA==taxa) %>%
    dplyr::select(STUDY_ID,newsite,LATITUDE,LONGITUDE)

  sitemap<-leaflet(dat) %>% addTiles() %>%
    addMarkers(~LONGITUDE, ~LATITUDE, label = ~htmlEscape(newsite))%>%
    addControl(paste(taxa,", n = ",nrow(dat),sep=""), position = "bottomleft", className="map-title")
  sitemaplist[[i]]<-sitemap
  f<-here(paste("Results/res_Prelim_Report/samplingsite_",taxa,
           ".html",sep=""))
  htmlwidgets::saveWidget(sitemap,
                          file.path(normalizePath(dirname(f)),basename(f)))
}
#par(op)
#htmltools::includeHTML("../Results/res_Prelim_Report/samplingsite_birds.html")
sitemaplist[[1]]
sitemaplist[[2]]
sitemaplist[[3]]
sitemaplist[[4]]
```

# Methods

I want to see how community stability-drivers relationship would affect by the changing environmental variable (annual temperature distribution). Temperature could vary in many ways (see \@ref(fig:drawing-figure)). I am considering three aspects of environmental (temperature) timeseries here: median of annual temperatures ($t_{med}$) during the study periods, trend ($t_{trend}$) and skewness ($t_{skw}$) of annual temperature timeseries for a given community.
My intuition is:

  - community stability would be affected by any of these temperature component either directly or indirectly via the drivers.
  - My hypothesis for **direct effect** is: warming environment (i.e., increasing any of these temperature components) should make the total productivity (community level abundance or biomass) more variable - so should decrease community stability.
  
  - For **indirect effect** via richness: increasing temperature (i.e. $t_{med}$, $t_{trend}$) might increase or decrease species richness and diversity-stability relationship could be affected via portfolio effect, or via the factors which are affected by the richness. e.g. terrestrial plants, beetles, and vertebrates show declining richness with incresing temperature in the past studies. [***Shya: add citations for birds and fish particularly which shows increasing or decreasing richness due to temperature change].
  
  - For **indirect effect** via overall synchrony (variance ratio): Similarly, changing $t_{med}$, $t_{trend}$ should relate how species interactions get modified in a changing environment, i.e., affecting the synchrony level (variance ratio). For example, as temperature increases (or decreases) $t_{med}$, community might loose some species, and might be dominated by fewer species which may or may not be synchronous, depending on the species-traits at that particular environment. If the community is exposing to warmer environment, then maybe warm adapted species will become dominant and species with similar traits can have higher synchrony. I am not sure, what will happen, but we can see how community-level response (avg of all species'response to warming for a given community) changes with temperature across the communities? [***Shya: add citations for birds and fish particularly which shows increasing or decreasing synchrony due to temperature change].[***Shya: we can test this with standardized correlation, shown later in Sec. \@ref(explanations).]
  
  - For **indirect effect** via tail-dependent synchrony (total tail asymmetry): Community level tail dependent synchrony (A) is the measure of how much species pair are synchronous in their extreme values (rare or common). It is reasonable to think that with increasing $t_{trend}$, species would be more similar in their extreme values - continuous warming/cooling could make the species assembly similar - either species become simultaneously rare (if all could not adapt well in warmer condition) or abundant (due to release from competitive pressure from other species which could not adapt well in warmer environment but were dominant otherwise). On the other hand, a finite $t_{skw}$ means extreme events (like heatwaves or cold winter) which should be related to species' extremes, especially if species response is regulated by some environmental threshold-like phenomena. Now depending on the tolerance limit (or temperature threshold) of all the species in a given community, their synchronous response in the extremes could differ. For example, if all species have similar tolerance limit then an extreme heat or winter event would make them more synchronous in their tails - so skewness would increase tail dependent synchrony. But if the species in the community vary in their tolerance limits then an extreme event (skewed temperature timeseries) would decrease the tail dependent synchrony. [***Shya: maybe we can test this with STI-related concept]

```{r drawing-figure, echo=FALSE, fig.cap="Temperature timeseries figure", out.width = '100%', fig.align='center'}
#knitr::include_graphics("../Results/some_assets/drawing.jpg")
knitr::include_graphics(here("Results/some_assets/drawing.jpg"),
                        rel_path = FALSE)# CHEK LATER TO HOW USE HERE
```


```{r realdata-timeseries, echo=FALSE, fig.cap="Temperature timeseries figure with real data", out.width = '100%', fig.align='center'}
#here("Results/some_assets/Intro_figure.png")
knitr::include_graphics(here("Results/some_assets/realdata_temperature_timeseries.jpg"),
                        rel_path = FALSE)
```

## Variables estimated and modelled

(Perhaps make this into a table.)

Let $N_{i,t,s}$ be the abundance (sometimes it was biomass data when abundance data were not available) of species $i$ at time $t$ at site $s$. Total abundance at time $t$ at site $s$ is $N_{t,s} = \sum_{i=1}^{s} N_{t,s,i}$. 

*Community stability* at site $s$ was estimated as the inverse of the coefficient of temporal variation in total community abundance (when abundance info were not available, then biomass): $TempStab_s = 1 / CV(N_{t,s}) = median(N_{t,s}) / IQR(N_{t,s})$

*Species richness* at site $s$ was estimated as the number of total species ($nsp$) and dominant species that were present minimum 70% of the total years sampled ($R$).

*Community variance ratio*: a measure of synchrony, scaled between 0 to 1 ([Loreau & Mazancourt](https://www.journals.uchicago.edu/doi/10.1086/589746)).

*Community level total tail association from pairwise synchrony*: see BioDyn project, Figure 1.

*Temperature median*: Median of CHELSA-extracted annual temperature timeseries for the study years included in the analysis for each community.

*Temperature trend*: Monotonic trend of annual temperature timeseries (computed by non-parametric Sen's method or parametric linear fit slope). I used the Sen's slope in the path model, as non-parametric estimation has some advantage[, see wikipedia](https://en.wikipedia.org/wiki/Theil%E2%80%93Sen_estimator), but it is very similar to linear slope (see \@ref(fig:trend-plot-compare)).

*Temperature skew*: Skewness of CHELSA-extracted annual temperature timeseries for the study years included in the analysis for each community.

*Temperature variability*: Temperature variability for the community during the study period = median(annual temperature)/IQR(annual temperature distribution for the study period). 
[Not included in the path model, see explanation in Sec. \@ref(exclude-tvar).]

# Results

## Community stability exploration

```{r categorize-data}
## Add the categotical temperature variable for birds and fish
## Note that the cutoffs are calculated separate for birds and for fish
## Also do the same for number of species
q_T_birds <- sm_all %>%
  filter(TAXA=="birds") %>%
  summarise(q=quantile(t_med,c(0.25,0.75))) %>%
  pull(q)
q_T_fish <- sm_all %>%
  filter(TAXA=="fish") %>%
  summarise(q=quantile(t_med,c(0.25,0.75))) %>%
  pull(q)
sm_all <- sm_all %>%
  mutate(median_temperature_cat = case_when(TAXA == "birds" & t_med < q_T_birds[1] ~ "low T, <50%CI",
                                          TAXA == "birds" & t_med > q_T_birds[2] ~ "high T, >50%CI",
                                          TAXA == "birds" & t_med <= q_T_birds[2] & t_med >= q_T_birds[1] ~ "mid T, in 50%CI",
                                          TAXA == "fish" & t_med < q_T_fish[1] ~ "low T, <50%CI",
                                          TAXA == "fish" & t_med > q_T_fish[2] ~ "high T, >50%CI",
                                          TAXA == "fish" & t_med <= q_T_fish[2] & t_med >= q_T_fish[1] ~ "mid T, in 50%CI")) %>%
  mutate(median_temperature_cat = fct_relevel(median_temperature_cat, "low T, <50%CI", "mid T, in 50%CI", "high T, >50%CI"))


## and for species richness
q_nsp_birds <- sm_all %>%
  filter(TAXA=="birds") %>%
  summarise(q=quantile(nsp,c(0.25,0.75))) %>%
  pull(q)
q_nsp_fish <- sm_all %>%
  filter(TAXA=="fish") %>%
  summarise(q=quantile(nsp,c(0.5))) %>% # note the change, it is now categorized around median
  pull(q)

sm_all <- sm_all %>%
  mutate(richness_cat = case_when(TAXA == "birds" & nsp < q_nsp_birds[1] ~ "low richness, <50%CI",
                                          TAXA == "birds" & nsp > q_nsp_birds[2] ~ "high richness, >50%CI",
                                          TAXA == "birds" & nsp <= q_nsp_birds[2] & nsp >= q_nsp_birds[1] ~ "mid richness, in 50%CI",
                                          TAXA == "fish" & nsp < q_nsp_fish[1] ~ "low richness, <median",
                                          TAXA == "fish" & nsp >= q_nsp_fish[1] ~ "high richness, >median")) %>%
  mutate(richness_cat = fct_relevel(richness_cat,
                                              "low richness, <50%CI",
                                             "mid richness, in 50%CI",
                                              "high richness, >50%CI"))
#sm_all
```

```{r plot-stability-diversity, echo=F, out.width = '75%',fig.cap=c("Stability-diversity relationship for birds and fish.")}
library(dplyr)
library(tidyverse)
#----- stability vs richness rawdata plot for each taxa -----
sm_all %>%
  filter(TAXA%in%c("birds","fish")) %>%
  ggplot(aes(x=nsp,y=iCValt)) +
  geom_point(alpha=0.3) +
  geom_smooth(method="lm") +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  xlab("Richness") +
  ylab("Community stability") +
  facet_wrap(~TAXA) +
  theme_bw()
```

### Birds

```{r birds-data}
library(dplyr)
library(tidyverse)

#----- plots for birds -----
taxa<-"birds"

# select taxa to plot
sb <- sm_all %>%
  filter(TAXA==taxa)
```


```{r plot-stability-diversity-birds, echo=F, out.width = '75%',fig.cap=c("Stability-diversity relationship for birds at different temperature levels")}
#---- stability versus richness, by temperature category for birds -----
ggplot(data=sb,aes(x=nsp,y=iCValt, col = median_temperature_cat)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  ylab("Stability, log2 scale") +
  xlab("Richness, log2 scale") +
  ggtitle(taxa) +
  theme_bw()
```

```{r plot-stability-temperature-birds, echo=F, out.width = '75%',fig.cap=c("Stability-temperature relationship for bird communities at different richness levels")}
#---- stability versus temperature, by richness category for birds -----
ggplot(data=sb,aes(x=t_med, y=iCValt, col = richness_cat)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  ylab("Stability, log2 scale") +
  xlab("Temperature (t_med)") +
  ggtitle(taxa) +
  theme_bw()
```

```{r plot-stability-synchrony-birds, echo=F, out.width = '75%',fig.cap=c("Stability-synchrony relationship for birds at different temperature levels")}
#---- stability versus synchrony, by temperature category for birds ----
ggplot(data=sb, aes(x=phi_LdM, y=iCValt, col = median_temperature_cat)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2')+
  ylab("Stability, log2 scale")+xlab("Synchrony, VR_LdM, log2 scale")+
  ggtitle(taxa)+
  theme_bw()
```

```{r plot-synchrony-temperature-birds-tempcat, echo=F, out.width = '75%',fig.cap=c("Synchrony-temperature relationship (scatterplot)")}
#---- synchrony versus temperature for birds ----
ggplot(data=sb, aes(x=t_med, y=phi_LdM, col = median_temperature_cat)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2')+
  xlab("Temperature (t_med)")+
  ylab("Synchrony, VR_LdM, log2 scale")+
  ggtitle(taxa)+
  theme_bw()
```

```{r boxplot-synchrony-temperature-birds, echo=F, out.width = '75%',fig.cap=c("Synchrony-temperature relationship (boxplot)")}
#----- do a boxplot for synchrony at low/high temp, birds -----
ggplot(data=sb, aes(x=median_temperature_cat, y=phi_LdM)) +
  geom_boxplot(alpha = 0.2) +
  scale_y_continuous(trans = 'log2')+
  xlab("Temperature category (t_med)")+
  ylab("Synchrony, VR_LdM, log2 scale")+
  ggtitle(taxa)+
  theme_bw()
```

```{r plot-synchrony-diversity-birds, echo=F, out.width = '75%',fig.cap=c("Synchrony richness relationship.")}
#---- synchrony versus richness, by temperature category ----
ggplot(data=sb,aes(x=nsp,y=phi_LdM, col = median_temperature_cat)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  ylab("Synchrony, VR_LdM, log2 scale") +
  xlab("Richness, log2 scale") +
  ggtitle(taxa) +
  theme_bw()
```

```{r plot-synchrony-temperature-birds, echo=F, out.width = '75%',fig.cap=c("Synchrony temperature relationship.")}
#---- synchrony versus temperature, by richness category for birds ----
ggplot(data=sb,aes(x=t_med, y=phi_LdM, col = richness_cat)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  ylab("Synchrony, VR_LdM, log2 scale") +
  xlab("Temperature (t_med)") +
  ggtitle(taxa) +
  theme_bw()
```

```{r plot-stability-tskw-birds, echo=F, out.width = '75%',fig.cap=c("Stability - temperature skew relationship.")}

ggplot(data=sb,aes(x=t_skw, y=iCValt, col = richness_cat)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm", se=T) +
  #scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  ylab("Stability, log2 scale") +
  xlab("Temperature skew (t_skew)") +
  ggtitle(taxa) +
  theme_bw()
```

#### Basic statistics for birds

**Model of bird stability:**
```{r anova_birds_stability}
## bird stability model
bird_stab1 <- lm(log2(iCValt) ~ log2(nsp) * t_med, data = sb)
par(mfrow = c(2,2))
#plot(bird_stab1)
anova_bird_stab1 <- tidy(bird_stab1)
  knitr::kable(anova_bird_stab1, digits = 4)
```

**Model of bird synchrony:**
```{r anova_birds_synchrony}
## bird stability model
bird_stab2 <- lm(log2(phi_LdM) ~ log2(nsp) * t_med, data = sb)
par(mfrow = c(2,2))
#plot(bird_stab2)
anova_bird_stab2 <- tidy(bird_stab2)
knitr::kable(anova_bird_stab2, digits = 4)
```

#### Bird conclusions

Bird communities display a positive richness stability relationship. This relationship is stronger at higher temperatures. Equally, high richness bird communities are more stable at higher temperatures, while low richness bird communities are less stable at higher temperatures.

There is some suggestion that this may be explained by synchrony, but the statistics show no strong associations of synchrony with $t_med$ or synchrony.


### Fish

```{r fish-data}
library(dplyr)
library(tidyverse)

#----- plots for birds -----
taxa<-"fish"

# select taxa to plot
sfi <- sm_all %>%
  filter(TAXA==taxa)
```

```{r plot-stability-diversity-fish, echo=F, out.width = '75%',fig.cap=c("Stability-diversity relationship at different temperature levels")}
#---- stability versus richness, by temperature category for fish -----
ggplot(data=sfi,aes(x=nsp,y=iCValt, col = median_temperature_cat)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  ylab("Stability, log2 scale") +
  xlab("Richness, log2 scale") +
  ggtitle(taxa) +
  theme_bw()
```

```{r plot-stability-temperature-fish, echo=F, out.width = '75%',fig.cap=c("Stability-temperature relationship at different richness levels")}
#----- stability versus temperature, by richness category for fish ----
ggplot(data=sfi,aes(x=t_med, y=iCValt, col = richness_cat)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  ylab("Stability, log2 scale") +
  xlab("Temperature (t_med)") +
  ggtitle(taxa) +
  theme_bw()
```

```{r plot-stability-synchrony-fish, echo=F, out.width = '75%',fig.cap=c("Stability-synchrony relationship at different temperature levels")}
#---- stability versus synchrony, by temperature category for fish ----
ggplot(data=sfi, aes(x=phi_LdM, y=iCValt, col = median_temperature_cat)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2')+
  ylab("Stability, log2 scale")+xlab("Synchrony, VR_LdM, log2 scale")+
  ggtitle(taxa)+
  theme_bw()
```

```{r plot-synchrony-temperature-fish-tempcat, echo=F, out.width = '75%',fig.cap=c("Synchrony-temperature relationship (scatterplot)")}
#---- synchrony versus temperature for fish ----
ggplot(data=sfi, aes(x=t_med, y=phi_LdM, col = median_temperature_cat)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2')+
  xlab("Temperature (t_med)")+
  ylab("Synchrony, VR_LdM, log2 scale")+
  ggtitle(taxa)+
  theme_bw()
```

```{r boxplot-synchrony-temperature-fish, echo=F, out.width = '75%',fig.cap=c("Synchrony-temperature relationship (boxplot)")}
#----- boxplot for synchrony at low/high temp, fish -----
ggplot(data=sfi, aes(x=median_temperature_cat, y=phi_LdM)) +
  geom_boxplot(alpha = 0.2) +
  scale_y_continuous(trans = 'log2')+
  xlab("Temperature category (t_med)")+
  ylab("Synchrony, VR_LdM, log2 scale")+
  ggtitle(taxa)+
  theme_bw()
```

```{r plot-synchrony-richness-fish, echo=F, out.width = '75%',fig.cap=c("Synchrony richness relationship.")}
#---- synchrony versus richness, by temperature category for fish ----
ggplot(data=sfi,aes(x=nsp,y=phi_LdM, col = median_temperature_cat)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  ylab("Synchrony, VR_LdM, log2 scale") +
  xlab("Richness, log2 scale") +
  ggtitle(taxa) +
  theme_bw()
```

```{r plot-synchrony-temperature-fish, echo=F, out.width = '75%',fig.cap=c("Synchrony temperature relationship.")}
#---- synchrony versus temperature, by richness category for fish ----
ggplot(data=sfi,aes(x=t_med, y=phi_LdM, col = richness_cat)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm", se=T) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  ylab("Synchrony, VR_LdM, log2 scale") +
  xlab("Temperature (t_med)") +
  ggtitle(taxa) +
  theme_bw()
```

```{r plot-stability-tskw-fish, echo=F, out.width = '75%',fig.cap=c("Stability - temperature skew relationship.")}

ggplot(data=sfi,aes(x=t_skw, y=iCValt, col = richness_cat)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm", se=T) +
  #scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  ylab("Stability, log2 scale") +
  xlab("Temperature skew (t_skew)") +
  ggtitle(taxa) +
  theme_bw()
```

#### Fish basic statistics

**Model of fish stability:**
```{r anova_fish_stability}
## fish stability model
fish_stab1 <- lm(log2(iCValt) ~ log2(nsp) * t_med, data = sfi)
par(mfrow = c(2,2))
#plot(fish_stab1)
anova_fish_stab1 <- tidy(fish_stab1)
  knitr::kable(anova_fish_stab1, digits = 4)
```

**Model of fish synchrony:**
```{r anova_fish_synchrony}
## bird stability model
fish_stab2 <- lm(log2(phi_LdM) ~ log2(nsp) * t_med, data = sfi)
par(mfrow = c(2,2))
#plot(fish_stab2)
anova_fish_stab2 <- tidy(fish_stab2)
knitr::kable(anova_fish_stab2, digits = 4)
```

#### Fish conclusions

Fish communities display a positive richness stability relationship at low temperature, and a negative one at higher temperatures. This is the opposite of the interaction pattern for birds, where the relationship became more positive when temperature was higher. Equally, high richness fish communities are slightly less stable at higher temperatures, while low richness fish communities are more stable at higher temperatures (again the opposite to the bird patterns).

Not sure, at present, how much can be explained by synchrony, but the statistics show no strong associations of synchrony with t_med or richness.

**Which pattern / finding are we trying to explain with the following two graphs?**

```{r tskew-plot1, out.width = '75%', fig.cap=c("Distribution of temperature skewness, birds and fish together.")}
sm_all_bf<-sm_all%>%filter(TAXA%in%c("birds","fish"))
br <- c(min(sm_all_bf$t_skw),0,max(sm_all_bf$t_skw))
sm_all_bf%>%
  ggplot( aes(x=t_skw, stat(density))) +
  ggtitle("birds and fish")+
  geom_text(
    aes(label = round(stat(count) / sum((count)), 3)),
    stat = 'bin', vjust = -0.5, breaks = br
  )+ ylim(c(0, 1))+geom_density()+
  annotate("rect", xmin=min(sm_all_bf$t_skw), xmax=0, ymin=0, ymax=1, alpha=0.15, fill="blue")+
  annotate("rect", xmin=0, xmax=max(sm_all_bf$t_skw), ymin=0, ymax=1, alpha=0.15, fill="red")+
  theme_classic()
```

```{r tskew-plot2, out.width = '75%', fig.cap=c("Distribution of temperature skewness, birds and fish separate. Fish communities generally experience more negatively skewed temperature fluctuations. In the fish SEM we see that t_skw directly affects stability, with more positive skew being associated with less stability. No evidence of association of t_skw and stability in birds.")}
#----- skewness plot across taxa, fish gets more extremes but as taildep synchrony is not important driver for freshwater systems stability is directly affected by skewness there ----

sm_all_bf%>%
  ggplot( aes(x=t_skw,y=..scaled..))+geom_density()+ylim(c(0, 1))+
  annotate("rect", xmin=min(sm_all_bf$t_skw), xmax=0, ymin=0, ymax=1, alpha=0.15, fill="blue")+
  annotate("rect", xmin=0, xmax=max(sm_all_bf$t_skw), ymin=0, ymax=1, alpha=0.15, fill="red")+
  theme_classic()+facet_wrap(~TAXA)
```

```{r trend-plot-compare, out.width = '75%', fig.cap="Distribution of temperature trend estimated by non-parametric Sen's slope, and parametric linear fit slope. Colored points are significant Sen's slope (green: birds, blue: fish)."}
# simulated data trend plot: see test_trend_bothway.R

# Now you can plot them from real data
slope_sig_bf<-sm_all_bf%>%filter(t.sens.slope.sig==1)
plot(x=sm_all_bf$t.sens.slope,y=sm_all_bf$t.lm.slope,col=rgb(0,0,0,0.05),
     pch=19,xlim=c(-1,1.5),ylim=c(-1,1.5),xlab="Sen's slope",ylab="lm.slope")
slope_sig_bf$col<-ifelse(slope_sig_bf$REALM=="Freshwater","blue","green")
points(x=slope_sig_bf$t.sens.slope,y=slope_sig_bf$t.lm.slope,col=slope_sig_bf$col)
abline(h=0,col="black",lty=2)
abline(v=0,col="black",lty=2)
table(slope_sig_bf$REALM)/table(sm_all_bf$REALM) # 34% freshwater, and 25% terrestrial sig trend
# at least from primary visualization, 
# I can see slopes when > 0.25 has higher chance to be significant
```

```{r trend-plot, out.width = '75%', fig.cap=c("Histogram plot for trends, both taxa.","Histogram plot for significant trends, both taxa.")}

gp1<-sm_all_bf%>%
  ggplot( aes(x=t.sens.slope))+geom_histogram()+xlim(-1.5,1.5)+xlab("Sen's slope, all")+
  annotate("rect", xmin=min(sm_all_bf$t.sens.slope), xmax=0, ymin=0, ymax=Inf, alpha=0.15, fill="blue")+
  annotate("rect", xmin=0, xmax=max(sm_all_bf$t.sens.slope), ymin=0, ymax=Inf, alpha=0.15, fill="red")+
  theme_classic()+facet_wrap(~TAXA)
print(gp1)

gp2<-slope_sig_bf%>%
  ggplot( aes(x=t.sens.slope))+geom_histogram()+xlim(-1.5,1.5)+xlab("Sen's slope, siginificant")+
  annotate("rect", xmin=min(slope_sig_bf$t.sens.slope), xmax=0, ymin=0, ymax=Inf, alpha=0.15, fill="blue")+
  annotate("rect", xmin=0, xmax=max(slope_sig_bf$t.sens.slope), ymin=0, ymax=Inf, alpha=0.15, fill="red")+
  theme_classic()+facet_wrap(~TAXA)
print(gp2)
```

```{r tvar-plot, out.width = '75%', fig.cap=c("Histogram plot for variability in temperature")}
gp3<-sm_all_bf%>%
  ggplot( aes(x=t_var))+geom_histogram()+
   theme_classic()+facet_wrap(~TAXA)
print(gp3)
```

## Explanations {#explanations}

So, from the exploratory plots we can see: at higher temperature positive stability-diversity relationship becomes stronger for birds but for fish it becomes weaker. Also fish becomes more asynchronous with increasing temperature. So, why does that happen? to find this we could explore how much the bird species and fish species are consistent to temperature change across all communities.

**The cue is:** if fish species are not much consistent in their response to warming and vary across sites, that means you cannot make a conclusion that they would become similar with changing temperature. On another note, bird species should be more consistent towards warming if their is no change in their synchrony level across communities. Another possibility could be with changing temperature you might loose some species (its not just number of individuals, it will selectively prefer few species with better fitness), and then the communities will be dominated by few species with similar traits (so increasing synchrony). we will test this below.

```{r check_consistency, echo=F, cache=T, message=F, cache.extra=list(mtime(here("Results/stability_metric_and_env_all.csv")), mtime(here("Results/birds_splist_consistency_table.csv")),mtime(here("Results/fish_splist_consistency_table.csv")),mtime(here("Results/birds_splist_with_temp_sensitivity.csv")),mtime(here("Results/fish_splist_with_temp_sensitivity.csv")))}

sm_all<-read.csv(here("Results/stability_metric_and_env_all.csv"))

#-------- plot for birds ----------------------------------------
taxa<-"birds"
cons_tab_all<-read.csv(here("Results/birds_splist_consistency_table.csv"))
df<-read.csv(here("Results/birds_splist_with_temp_sensitivity.csv"))

rg<-range(cons_tab_all$avgcorval)
rg1<-floor(rg[1])
rg2<-ceiling(rg[2])

hist(cons_tab_all$avgcorval,50,col="green",border=F,
     xlab="avg correlation across occurence sites",xlim=c(-1,1),
     main=paste("birds, ",nrow(cons_tab_all)," unique species across ",length(unique(df$newsite))," sites",sep=""))
abline(v=0,col="black",lty=2)
text(x=0.5, y=25, paste(round(100*sum(cons_tab_all$avgcorval>0)/nrow(cons_tab_all),2),"%"),
     col = "red", srt = 0)
text(x=-0.5, y=25, paste(round(100*sum(cons_tab_all$avgcorval<0)/nrow(cons_tab_all),2),"%"),
     col = "blue", srt = 0)

# now, make histogram for those species which occur in lowT_taxa
q_T_taxa<-sm_all%>%filter(TAXA==taxa)%>%summarise(q=quantile(t_med,c(0.25,0.75)))

lowT_taxa<-sm_all%>%filter(TAXA==taxa)%>%filter(t_med<=unname(q_T_taxa[1,1]))
highT_taxa<-sm_all%>%filter(TAXA==taxa)%>%filter(t_med>=unname(q_T_taxa[2,1]))

df_lowT_taxa<-df%>%filter(newsite%in%lowT_taxa$newsite)
df_highT_taxa<-df%>%filter(newsite%in%highT_taxa$newsite)

# first with lowT 
cons_tab_lowT_taxa<-df_lowT_taxa%>%group_by(spname)%>%
  summarise(poscorsite=sum(spearcor_with_t>0),
            negcorsite=sum(spearcor_with_t<0),
            zerocorsite=sum(spearcor_with_t==0),
            poscorval=sum(spearcor_with_t[which(spearcor_with_t>0)]),
            negcorval=sum(spearcor_with_t[which(spearcor_with_t<0)]),
            zerocorval=sum(spearcor_with_t[which(spearcor_with_t==0)]))%>%ungroup()%>%
  group_by(spname)%>%mutate(occur_sites=sum(poscorsite,negcorsite,zerocorsite))%>%
  mutate(avgcorval=sum(poscorval,negcorval,zerocorval)/occur_sites)%>%ungroup()

hist(cons_tab_lowT_taxa$avgcorval,50,col="green",border=F,
     xlab="overall correlation across cold occurence sites",xlim=c(-1,1),
     main=paste("birds, ",nrow(cons_tab_lowT_taxa)," unique species across ",length(unique(df_lowT_taxa$newsite))," sites",sep=""))
abline(v=0,col="black",lty=2)
text(x=0.5, y=25, paste(round(100*sum(cons_tab_lowT_taxa$avgcorval>0)/nrow(cons_tab_lowT_taxa),2),"%"),
     col = "red", srt = 0)
text(x=-0.5, y=25, paste(round(100*sum(cons_tab_lowT_taxa$avgcorval<0)/nrow(cons_tab_lowT_taxa),2),"%"),
     col = "blue", srt = 0)

#sum(cons_tab_lowT_taxa$diffcor==0)
# 8 sp. show positive response to warming, 2 was independent

# then with highT 
cons_tab_highT_taxa<-df_highT_taxa%>%group_by(spname)%>%
  summarise(poscorsite=sum(spearcor_with_t>0),
            negcorsite=sum(spearcor_with_t<0),
            zerocorsite=sum(spearcor_with_t==0),
            poscorval=sum(spearcor_with_t[which(spearcor_with_t>0)]),
            negcorval=sum(spearcor_with_t[which(spearcor_with_t<0)]),
            zerocorval=sum(spearcor_with_t[which(spearcor_with_t==0)]))%>%ungroup()%>%
  group_by(spname)%>%mutate(occur_sites=sum(poscorsite,negcorsite,zerocorsite))%>%
  mutate(avgcorval=sum(poscorval,negcorval,zerocorval)/occur_sites)%>%ungroup()

hist(cons_tab_highT_taxa$avgcorval,50,col="green",border=F,
     xlab="overall correlation across hot occurence sites",xlim=c(-1,1),
     main=paste("birds, ",nrow(cons_tab_highT_taxa)," unique species across ",length(unique(df_highT_taxa$newsite))," sites",sep=""))
abline(v=0,col="black",lty=2)
text(x=0.5, y=25, paste(round(100*sum(cons_tab_highT_taxa$avgcorval>0)/nrow(cons_tab_highT_taxa),2),"%"),
     col = "red", srt = 0)
text(x=-0.5, y=25, paste(round(100*sum(cons_tab_highT_taxa$avgcorval<0)/nrow(cons_tab_highT_taxa),2),"%"),
     col = "blue", srt = 0)

#-------- plot for fish ------------------------------------
taxa="fish"
cons_tab_all<-read.csv(here("Results/birds_splist_consistency_table.csv"))
df<-read.csv(here("Results/fish_splist_with_temp_sensitivity.csv"))

hist(cons_tab_all$avgcorval,50,col="skyblue",border=F,
     xlab="overall correlation across occurence sites",xlim=c(-1,1),
     main=paste("fish, ",nrow(cons_tab_all)," unique species across ",length(unique(df$newsite))," sites",sep=""))
abline(v=0,col="black",lty=2)
text(x=0.5, y=8, paste(round(100*sum(cons_tab_all$avgcorval>0)/nrow(cons_tab_all),2),"%"),
     col = "red", srt = 0)
text(x=-0.5, y=8, paste(round(100*sum(cons_tab_all$avgcorval<0)/nrow(cons_tab_all),2),"%"),
     col = "blue", srt = 0)

# now, make histogram for those species which occur in lowT_taxa
q_T_taxa<-sm_all%>%filter(TAXA==taxa)%>%summarise(q=quantile(t_med,c(0.25,0.75)))
#q_T_taxa<-sm_all%>%filter(TAXA==taxa)%>%summarise(q=quantile(t_med,c(0.35,0.65)))

lowT_taxa<-sm_all%>%filter(TAXA==taxa)%>%filter(t_med<=unname(q_T_taxa[1,1]))
highT_taxa<-sm_all%>%filter(TAXA==taxa)%>%filter(t_med>=unname(q_T_taxa[2,1]))

df_lowT_taxa<-df%>%filter(newsite%in%lowT_taxa$newsite)
df_highT_taxa<-df%>%filter(newsite%in%highT_taxa$newsite)

# first with lowT 
cons_tab_lowT_taxa<-df_lowT_taxa%>%group_by(spname)%>%
  summarise(poscorsite=sum(spearcor_with_t>0),
            negcorsite=sum(spearcor_with_t<0),
            zerocorsite=sum(spearcor_with_t==0),
            poscorval=sum(spearcor_with_t[which(spearcor_with_t>0)]),
            negcorval=sum(spearcor_with_t[which(spearcor_with_t<0)]),
            zerocorval=sum(spearcor_with_t[which(spearcor_with_t==0)]))%>%ungroup()%>%
  group_by(spname)%>%mutate(occur_sites=sum(poscorsite,negcorsite,zerocorsite))%>%
  mutate(avgcorval=sum(poscorval,negcorval,zerocorval)/occur_sites)%>%ungroup()

hist(cons_tab_lowT_taxa$avgcorval,10,col="skyblue",border=F,
     xlab="overall correlation across cold occurence sites",xlim=c(-1,1),
     main=paste("fish, ",nrow(cons_tab_lowT_taxa)," unique species across ",length(unique(df_lowT_taxa$newsite))," sites",sep=""))
abline(v=0,col="black",lty=2)
text(x=0.5, y=1, paste(round(100*sum(cons_tab_lowT_taxa$avgcorval>0)/nrow(cons_tab_lowT_taxa),2),"%"),
     col = "red", srt = 0)
text(x=-0.5, y=1, paste(round(100*sum(cons_tab_lowT_taxa$avgcorval<0)/nrow(cons_tab_lowT_taxa),2),"%"),
     col = "blue", srt = 0)

#sum(cons_tab_lowT_taxa$diffcor==0)
# 8 sp. show positive response to warming, 2 was independent

# then with highT 
cons_tab_highT_taxa<-df_highT_taxa%>%group_by(spname)%>%
  summarise(poscorsite=sum(spearcor_with_t>0),
            negcorsite=sum(spearcor_with_t<0),
            zerocorsite=sum(spearcor_with_t==0),
            poscorval=sum(spearcor_with_t[which(spearcor_with_t>0)]),
            negcorval=sum(spearcor_with_t[which(spearcor_with_t<0)]),
            zerocorval=sum(spearcor_with_t[which(spearcor_with_t==0)]))%>%ungroup()%>%
  group_by(spname)%>%mutate(occur_sites=sum(poscorsite,negcorsite,zerocorsite))%>%
  mutate(avgcorval=sum(poscorval,negcorval,zerocorval)/occur_sites)%>%ungroup()

hist(cons_tab_highT_taxa$avgcorval,50,col="skyblue",border=F,
     xlab="overall correlation across hot occurence sites",xlim=c(-1,1),
     main=paste("fish, ",nrow(cons_tab_highT_taxa)," unique species across ",length(unique(df_highT_taxa$newsite))," sites",sep=""))
abline(v=0,col="black",lty=2)
text(x=0.5, y=6, paste(round(100*sum(cons_tab_highT_taxa$avgcorval>0)/nrow(cons_tab_highT_taxa),2),"%"),
     col = "red", srt = 0)
text(x=-0.5, y=6, paste(round(100*sum(cons_tab_highT_taxa$avgcorval<0)/nrow(cons_tab_highT_taxa),2),"%"),
     col = "blue", srt = 0)
```

```{r tmed_on_map, echo=F}
library(tidyverse)
library(leaflet)

plot_temp_on_map<-function(sm_all,t,taxa,scaleup){
  dat<-sm_all%>%filter(TAXA==taxa)%>%dplyr::select(STUDY_ID,newsite,nsp,LATITUDE,LONGITUDE,t_med,trend_t_tau,t_skw)

  # first cut the continuous variable into bins
  # these bins are now factors
  qt<-summary(dat[,t])
  qt<-unname(qt)
  qt<-qt[c(1,2,5,6)]

  dat$tmedLvl <- cut(dat[,t],
                     qt, include.lowest = T,
                     labels = c("<50%CI","50%CI",">50%CI"))

  # then assign a palette to this using colorFactor
  # in this case it goes from red for the smaller values to yellow and green
  # standard stoplight for bad, good, and best
  beatCol <- colorFactor(palette = c("blue","gray","red"), dat$tmedLvl)
  m1 <- leaflet() %>%
    addTiles() %>%
    addProviderTiles(providers$OpenStreetMap, group = 'Open SM')  %>%
    #setView(lng = -72, lat = 41, zoom = 8) %>%
    addCircleMarkers(data = dat, lat = ~LATITUDE, lng = ~LONGITUDE,
                     color = ~beatCol(tmedLvl), popup = dat$newsite,radius = ~sqrt(nsp*scaleup))%>%
    addLegend('bottomleft', pal = beatCol, values = dat$tmedLvl,
              title = paste(t,' for ',taxa),opacity = 0.5)
  m1
}

taxa<-"birds"
scaleup=1
plot_temp_on_map(sm_all,t="t_med",taxa,scaleup)

taxa<-"fish"
scaleup=3
plot_temp_on_map(sm_all,t="t_med",taxa,scaleup)
#plot_temp_on_map(sm_all,t="t_skw",taxa,scaleup)
```

From the above plots, we can see birds are showing consistent response-distribution across all temperature change, i.e., in either end of temperature spectrum (low or high end). That's why the synchrony level remains similar for birds.
But for fish, warming increases the richness (addition of new species), and as fish species now become more variable in response to temperature sensitivity (trait-variation), they show more asynchrony compared to low temperature scenario where only few species exists (see smaller circle size on the map for lowT,<50%CI) and show similar traits (so more synchrony).
**Note:** when I show this to Frank, he commented on how much robust is the pattern for fish at low T as there are only few species existed across 145 sites - so it also depends on how we considered the lowT-highT communities. I set beyond 50% CI of temperature range as low/high. Even if I decrease that to 30% CI, still very few species found in low T sites (15 sp across 203 sites: 80% >0, 20% <0 line).  

To further explore this idea: we collected traits data for birds and fish species used in the analysis. For fish-traits, I will use body length measurements, for bird-traits I will use HWI (Hand-wing index).
From below figures: at high T, birds have slightly less dispersal ability (lower HWI), but richness is more or less uniformly spread at either temperature range. For fish, at lowT, few large species exists with similar traits (remember the previous histogram plot 90-10) showing higher synchrony, as temperature increases addition of new small fishes in the community (maybe better environment for them to exist in that temperature rather than too cold water) makes them asynchronous with more trait variation (histogram plot 66-34).    

```{r plot_direct_traits, echo=F}
#---- plotting richness and traits for birds ----
# these are direct traits: body size
source(here("R/plot_birdtraits.R"))
source(here("R/plot_fishtraits.R"))
```

When I showed this to Blake, he was not convinced by the idea to split the data into two: low/high based on t_med (to him this temperature difference is more on latitudinal differences as shown in the map), and same species can exist in both communities - so why changing t_med should change the synchrony level for fish? and getting different bodysize fish from low/high t_med (fewer big fish in lowT and many smaller fish in highT) is not explaining why big fish should be more synchronous - is it because of fewer species (richness) or because bigger fish abundance change needs more time - not on annual scale?

So, I thought to make a plot of how community-level average response traits (average of standardised correlation between species abundance with t_med timeseries across sites) changes with increasing temperature (t_med)? For fish, it should decrease with increasing t_med, whereas for birds it should be a flat relationship.

```{r plot_tempcor_traits, echo=F}
# first for fish
library(tidyverse)
library(ggbreak)
library(dplyr)
sm_all<-read.csv(here("Results/stability_metric_and_env_all.csv"))
#range(sm_all$t_med)

#---- for fish -----
taxa<-"fish"
sfi<-sm_all%>%filter(TAXA==taxa)

# all cor with temperature

df<-read.csv(here("Results/fish_splist_with_temp_sensitivity.csv"))

# consistency table

dfc<-read.csv(here("Results/fish_splist_consistency_table.csv"))

# first extract temperature-cor traits per community
df<-df%>%dplyr::select(spearcor_with_t,STUDY_ID,newsite,spname)
df2<-left_join(df,dfc,by="spname")
df2<-df2%>%dplyr::select(spearcor_with_t,STUDY_ID,newsite,spname,avgcorval)

df3<-df2%>%group_by(STUDY_ID,newsite)%>%
  summarise(avgcortraitval=mean(avgcorval),
            cortrait_sd=sd(avgcorval),
            cortrait_var=sd(avgcorval)/abs(mean(avgcorval)))%>%ungroup()

mydat<-left_join(sfi,df3,by=c("STUDY_ID","newsite"))

#df4<-df3%>%filter(cortrait_var<0)

# response traits (avgvalue) vs. t_med plot
g1<-ggplot(mydat,aes(x=t_med,y=avgcortraitval))+
  geom_point(alpha=0.2)+
  geom_smooth(method="lm",color="blue",fill="cornflowerblue")+
  geom_hline(yintercept=0,linetype='dashed')+
  xlab("t_med, K/10 unit")+
  ylab("community-wide correlation traits (avg. value), fish")+
  xlim(2600,3000)+theme_bw()
print(g1)

# response traits (variability) vs. t_med plot
g1<-ggplot(mydat,aes(x=t_med,y=cortrait_var))+geom_point(alpha=0.2)+
  geom_smooth(method="lm",color="blue",fill="cornflowerblue")+
  geom_hline(yintercept=0,linetype='dashed')+
  #scale_y_break(c(11.5,38,56, 129))+
  #ylim(0,132)+
  xlab("t_med, K/10 unit")+
  ylab("community-wide correlation traits \n
       variability (absolute), fish")+
  xlim(2600,3000)+theme_bw()
print(g1)

g1wbrk<-ggplot(mydat,aes(x=t_med,y=cortrait_var))+geom_point(alpha=0.2)+
  geom_smooth(method="lm",color="blue",fill="cornflowerblue")+
  geom_hline(yintercept=0,linetype='dashed')+
  scale_y_break(c(11.5,38,56, 129))+
  ylim(0,132)+
  xlab("t_med, K/10 unit")+
  ylab("community-wide correlation traits \n
       variability (absolute), fish")+
  xlim(2600,3000)+theme_bw()
print(g1wbrk)

# richness vs. t_med plot
#ggplot(mydat,aes(x=t_med,y=nsp))+geom_point(alpha=0.2)+
#  geom_smooth(method="lm",color="blue",fill="cornflowerblue")+
#  xlab("t_med, K/10 unit")+ylab("Richness, fish")+
#  theme_bw()

#---- for birds -----
taxa<-"birds"
sfi<-sm_all%>%filter(TAXA==taxa)

# all cor with temperature
df<-read.csv(here("Results/birds_splist_with_temp_sensitivity.csv"))

# consistency table
dfc<-read.csv(here("Results/birds_splist_consistency_table.csv"))

# first extract temperature-cor traits per community
df<-df%>%dplyr::select(spearcor_with_t,STUDY_ID,newsite,spname)
df2<-left_join(df,dfc,by="spname")
df2<-df2%>%dplyr::select(spearcor_with_t,STUDY_ID,newsite,spname,avgcorval)

df3<-df2%>%group_by(STUDY_ID,newsite)%>%
  summarise(avgcortraitval=mean(avgcorval),
            cortrait_sd=sd(avgcorval),
            cortrait_var=sd(avgcorval)/abs(mean(avgcorval)))%>%ungroup()

mydat<-left_join(sfi,df3,by=c("STUDY_ID","newsite"))

# response traits vs. t_med plot
g1<-ggplot(mydat,aes(x=t_med,y=avgcortraitval))+
  geom_point(alpha=0.2)+
  geom_smooth(method="lm",color="green",fill="darkolivegreen1")+
  geom_hline(yintercept=0,linetype='dashed')+
  xlab("t_med, K/10 unit")+
  ylab("community-wide correlation traits (avg. value), birds")+
  xlim(2600,3000)+theme_bw()
print(g1)

# response traits (variability) vs. t_med plot
g1<-ggplot(mydat,aes(x=t_med,y=cortrait_var))+geom_point(alpha=0.2)+
  geom_smooth(method="lm",color="green",fill="darkolivegreen1")+
  geom_hline(yintercept=0,linetype='dashed')+
  #scale_y_log10()+
  xlab("t_med, K/10 unit")+
  ylab("community-wide correlation traits \n variability (absolute), birds")+
  xlim(2600,3000)+theme_bw()
print(g1)

# richness vs. t_med plot
#ggplot(mydat,aes(x=t_med,y=nsp))+geom_point(alpha=0.2)+
#  geom_smooth(method="loess",color="green",fill="darkolivegreen1")+
#  xlab("t_med, K/10 unit")+
#  ylab("Richness, birds")+
#  theme_bw()
```

Possible explanation:

```{r response-scematicfig, echo=FALSE, fig.cap="Response variation with temperature", out.width = '100%', fig.align='center'}
knitr::include_graphics(here("Results/some_assets/responsetraits.jpg"),
                        rel_path = FALSE)
```

Now, we will do a path analysis for a simplistic mixed effect model to see the environmental effects on community stability for both taxa.

```{r model_psem_with_meancentering, echo=F, cache=T, message=F, cache.extra=list(mtime(here("Results/stability_metric_and_env_all.csv")), mtime(here("R/plot_psem.R")))}

library(tidyverse)
library(lme4)
library(piecewiseSEM)
source(here("R/plot_psem.R"))

mean_centering<-TRUE
resloc<-here("Results/res_Prelim_Report/")

sm_all<-read.csv(here("Results/stability_metric_and_env_all.csv"))
sm_all$UID<-paste(sm_all$source,sm_all$STUDY_ID,sep="_")
sm_all$A<-sm_all$L+abs(sm_all$U) # total asymmetry
sm_all<-sm_all%>%dplyr::rename(
  stability=iCValt,
  VR=phi_LdM,
  R=nsp)

sm_all$TAXA<-as.factor(sm_all$TAXA)

#---------------- for birds -----------------------
taxa<-"birds"
sm_all_eachtaxa<-sm_all%>%filter(TAXA==taxa)

############ want rescaling? #################
mydat_scaled<-sm_all_eachtaxa
mydat_scaled$stability<-as.numeric(scale(mydat_scaled$stability,
                                         center=mean_centering,scale=T))
mydat_scaled$R<-as.numeric(scale(mydat_scaled$R,
                                 center=mean_centering,scale=T))
mydat_scaled$VR<- as.numeric(scale(mydat_scaled$VR,
                                   center=mean_centering,scale=T))
mydat_scaled$A<- as.numeric(scale(mydat_scaled$A,
                                  center=mean_centering,scale=T))

mydat_scaled$t_med<-as.numeric(scale(mydat_scaled$t_med,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_med<-as.numeric(scale(mydat_scaled$tmax_med,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_med<-as.numeric(scale(mydat_scaled$tmin_med,
                                        center=mean_centering,scale=T))

mydat_scaled$t_skw<-as.numeric(scale(mydat_scaled$t_skw,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_skw<-as.numeric(scale(mydat_scaled$tmax_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_skw<-as.numeric(scale(mydat_scaled$tmin_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$t_var<-as.numeric(scale(mydat_scaled$t_var,
                                     center=mean_centering,scale=T))
mydat_scaled$trend_t_tau<-as.numeric(scale(mydat_scaled$trend_t_tau,
                                           center=mean_centering,scale=T))
mydat_scaled$t.sens.slope<-as.numeric(scale(mydat_scaled$t.sens.slope,
                                            center=mean_centering,scale=T))
mydat_scaled$t.lm.slope<-as.numeric(scale(mydat_scaled$t.lm.slope,
                                          center=mean_centering,scale=T))
#---  


dat<-mydat_scaled
n<-nrow(dat)
#model_psem<-piecewiseSEM::psem(
#  lmer(VR ~ R+t.sens.slope+t_med+(1|UID),data=dat),
#  lmer(A ~ R+t.sens.slope+t_skw+(1|UID),data=dat),
#  lmer(R~t.sens.slope+t_med+(1|UID),data=dat),
#  lmer(stability ~ (R + VR +A)+t.sens.slope+t_skw+t_med+
#         (1|UID), data=dat))

#model_psem<-piecewiseSEM::psem(
#  lmer(VR ~ R+t_med+t.sens.slope+(1|UID),data=dat),
#  lmer(A ~ R+t.sens.slope+t_skw+(1|UID),data=dat),
#  lmer(R~t_med+t.sens.slope+(1|UID),data=dat),
#  lmer(stability ~ (R*t_med)+VR+A+t.sens.slope+t_skw+(1|UID), data=dat))

model_psem<-piecewiseSEM::psem(
  lmer(VR ~ R+t_med+t.sens.slope+(1|UID),data=dat),
  lmer(A ~ R+t.sens.slope+t_skw+(1|UID),data=dat),
  lmer(R~t_med+t_var+t.sens.slope+(1|UID),data=dat),
  lmer(stability ~ (R*t_med)+VR+A+t.sens.slope+t_skw+t_var+(1|UID), data=dat))

cc<-coefs(model_psem)
plot_psem(n,taxa,cc,layout="circle")
#print(summary(model_psem))
saveRDS(model_psem,paste(resloc,"model_psem_",taxa,".RDS",sep=""))

#---------------- for fish -----------------------
taxa<-"fish"
sm_all_eachtaxa<-sm_all%>%filter(TAXA==taxa)

############ want rescaling? #################
mydat_scaled<-sm_all_eachtaxa
mydat_scaled$stability<-as.numeric(scale(mydat_scaled$stability,
                                         center=mean_centering,scale=T))
mydat_scaled$R<-as.numeric(scale(mydat_scaled$R,
                                 center=mean_centering,scale=T))
mydat_scaled$VR<- as.numeric(scale(mydat_scaled$VR,
                                   center=mean_centering,scale=T))
mydat_scaled$A<- as.numeric(scale(mydat_scaled$A,
                                  center=mean_centering,scale=T))

mydat_scaled$t_med<-as.numeric(scale(mydat_scaled$t_med,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_med<-as.numeric(scale(mydat_scaled$tmax_med,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_med<-as.numeric(scale(mydat_scaled$tmin_med,
                                        center=mean_centering,scale=T))

mydat_scaled$t_skw<-as.numeric(scale(mydat_scaled$t_skw,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_skw<-as.numeric(scale(mydat_scaled$tmax_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_skw<-as.numeric(scale(mydat_scaled$tmin_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$t_var<-as.numeric(scale(mydat_scaled$t_var,
                                     center=mean_centering,scale=T))
mydat_scaled$trend_t_tau<-as.numeric(scale(mydat_scaled$trend_t_tau,
                                           center=mean_centering,scale=T))
mydat_scaled$t.sens.slope<-as.numeric(scale(mydat_scaled$t.sens.slope,
                                            center=mean_centering,scale=T))
mydat_scaled$t.lm.slope<-as.numeric(scale(mydat_scaled$t.lm.slope,
                                          center=mean_centering,scale=T))
#---  
dat<-mydat_scaled
n<-nrow(dat)

model_psem<-piecewiseSEM::psem(
  lmer(VR ~ R+t_med+t.sens.slope+(1|UID),data=dat),
  lmer(A ~ R+t.sens.slope+t_skw+(1|UID),data=dat),
  lmer(R~t_med+t_var+t.sens.slope+(1|UID),data=dat),
  lmer(stability ~ (R*t_med)+VR+A+t.sens.slope+t_skw+t_var+(1|UID), data=dat))

cc<-coefs(model_psem)
plot_psem(n,taxa,cc,layout="circle")
#print(summary(model_psem))
saveRDS(model_psem,paste(resloc,"model_psem_",taxa,".RDS",sep=""))
```

<!--- currently blocked code
```{r model_psem_without_meancentering, echo=F, cache=T, message=F, cache.extra=list(mtime(here("Results/stability_metric_and_env_all.csv")), mtime(here("R/plot_psem.R")))}

library(tidyverse)
library(lme4)
library(piecewiseSEM)
source(here("R/plot_psem.R"))

mean_centering<-FALSE
resloc<-here("Results/res_Prelim_Report/")

sm_all<-read.csv(here("Results/stability_metric_and_env_all.csv"))
sm_all$UID<-paste(sm_all$source,sm_all$STUDY_ID,sep="_")
sm_all$A<-sm_all$L+abs(sm_all$U) # total asymmetry
sm_all<-sm_all%>%dplyr::rename(
  stability=iCValt,
  VR=phi_LdM,
  R=nsp)

sm_all$TAXA<-as.factor(sm_all$TAXA)

#---------------- for birds -----------------------
taxa<-"birds"
sm_all_eachtaxa<-sm_all%>%filter(TAXA==taxa)

############ want rescaling? #################
mydat_scaled<-sm_all_eachtaxa
mydat_scaled$stability<-as.numeric(scale(mydat_scaled$stability,
                                         center=mean_centering,scale=T))
mydat_scaled$R<-as.numeric(scale(mydat_scaled$R,
                                 center=mean_centering,scale=T))
mydat_scaled$VR<- as.numeric(scale(mydat_scaled$VR,
                                   center=mean_centering,scale=T))
mydat_scaled$A<- as.numeric(scale(mydat_scaled$A,
                                  center=mean_centering,scale=T))

mydat_scaled$t_med<-as.numeric(scale(mydat_scaled$t_med,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_med<-as.numeric(scale(mydat_scaled$tmax_med,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_med<-as.numeric(scale(mydat_scaled$tmin_med,
                                        center=mean_centering,scale=T))

mydat_scaled$t_skw<-as.numeric(scale(mydat_scaled$t_skw,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_skw<-as.numeric(scale(mydat_scaled$tmax_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_skw<-as.numeric(scale(mydat_scaled$tmin_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$t_var<-as.numeric(scale(mydat_scaled$t_var,
                                     center=mean_centering,scale=T))
mydat_scaled$trend_t_tau<-as.numeric(scale(mydat_scaled$trend_t_tau,
                                           center=mean_centering,scale=T))
mydat_scaled$t.sens.slope<-as.numeric(scale(mydat_scaled$t.sens.slope,
                                            center=mean_centering,scale=T))
mydat_scaled$t.lm.slope<-as.numeric(scale(mydat_scaled$t.lm.slope,
                                          center=mean_centering,scale=T))
#---  


dat<-mydat_scaled
n<-nrow(dat)
#model_psem<-piecewiseSEM::psem(
#  lmer(VR ~ R+t.sens.slope+t_med+(1|UID),data=dat),
#  lmer(A ~ R+t.sens.slope+t_skw+(1|UID),data=dat),
#  lmer(R~t.sens.slope+t_med+(1|UID),data=dat),
#  lmer(stability ~ (R + VR +A)+t.sens.slope+t_skw+t_med+
#         (1|UID), data=dat))
model_psem<-piecewiseSEM::psem(
  lmer(VR ~ R+t_med+t.sens.slope+(1|UID),data=dat),
  lmer(A ~ R+t.sens.slope+t_skw+(1|UID),data=dat),
  lmer(R~t_med+t.sens.slope+(1|UID),data=dat),
  lmer(stability ~ (R*t_med)+VR+A+t.sens.slope+t_skw+(1|UID), data=dat))
cc<-coefs(model_psem)
plot_psem(n,taxa,cc,layout="circle")
#print(summary(model_psem))
saveRDS(model_psem,paste(resloc,"model_psem_wo_meancentering_",taxa,".RDS",sep=""))

#---------------- for fish -----------------------
taxa<-"fish"
sm_all_eachtaxa<-sm_all%>%filter(TAXA==taxa)

############ want rescaling? #################
mydat_scaled<-sm_all_eachtaxa
mydat_scaled$stability<-as.numeric(scale(mydat_scaled$stability,
                                         center=mean_centering,scale=T))
mydat_scaled$R<-as.numeric(scale(mydat_scaled$R,
                                 center=mean_centering,scale=T))
mydat_scaled$VR<- as.numeric(scale(mydat_scaled$VR,
                                   center=mean_centering,scale=T))
mydat_scaled$A<- as.numeric(scale(mydat_scaled$A,
                                  center=mean_centering,scale=T))

mydat_scaled$t_med<-as.numeric(scale(mydat_scaled$t_med,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_med<-as.numeric(scale(mydat_scaled$tmax_med,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_med<-as.numeric(scale(mydat_scaled$tmin_med,
                                        center=mean_centering,scale=T))

mydat_scaled$t_skw<-as.numeric(scale(mydat_scaled$t_skw,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_skw<-as.numeric(scale(mydat_scaled$tmax_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_skw<-as.numeric(scale(mydat_scaled$tmin_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$t_var<-as.numeric(scale(mydat_scaled$t_var,
                                     center=mean_centering,scale=T))
mydat_scaled$trend_t_tau<-as.numeric(scale(mydat_scaled$trend_t_tau,
                                           center=mean_centering,scale=T))
mydat_scaled$t.sens.slope<-as.numeric(scale(mydat_scaled$t.sens.slope,
                                            center=mean_centering,scale=T))
mydat_scaled$t.lm.slope<-as.numeric(scale(mydat_scaled$t.lm.slope,
                                          center=mean_centering,scale=T))
#---  
dat<-mydat_scaled
n<-nrow(dat)
model_psem<-piecewiseSEM::psem(
  lmer(VR ~ R+t_med+t.sens.slope+(1|UID),data=dat),
  lmer(A ~ R+t.sens.slope+t_skw+(1|UID),data=dat),
  lmer(R~t_med+t.sens.slope+(1|UID),data=dat),
  lmer(stability ~ (R*t_med)+VR+A+t.sens.slope+t_skw+(1|UID), data=dat))
cc<-coefs(model_psem)
plot_psem(n,taxa,cc,layout="circle")
#print(summary(model_psem))
saveRDS(model_psem,paste(resloc,"model_psem_wo_meancentering_",taxa,".RDS",sep=""))
```
--->

So, from the path analysis, what do we see for birds -

- for birds: increasing richness increases stability (positive diversity-stability relationship is confirmed). But temperature plays an important role in detecting the slope or strength of such relationship. High temperature increases the positive slope compared to low temperature. 
- increasing temperature trend also has no significant effect on birds.
- increasing extreme heatwaves decreases tail dependent synchrony. We guess this is because Here direct effect of t_skw is not significant on stability, as all bird data have equal proportion of +ve and -ve skewness (see above plot). But still tail dependent synchrony is important mechanism for stability, especially for terrestrial taxa (we found this from BioDyn project), and driven by the skewness of temperature time series (extreme events).

and for fish -

- overall synchrony (variance ratio) is the important determinant for stability (this we knew from BioDyn project findings), as it connects the environmental effects to stability.
- increasing $t_{med}$ increases richness, and more asynchrony (-ve effect on VR), which is also consistent with more variable traits for the fish species.
- for fish, skewness has direct negative effect on stability, not indirect effect through tail-dep synchrony as it is not important driver for freshwater as we found from BioDyn. Increasing temperature trend increases tail-dependent synchrony.

<!-- currently blocked portion 
### Why I did not choose t_var (variability in temperature timeseries) in the path model? {#exclude-tvar}

As I already have added the t_med as one of the variable in the path model, including again it as t_var would increase the multi-collinearity (as increasing VIF). Also we added the t_skw, so together with t_med, it should give you an estimation of whole temperature timeseries distribution - and would be better as directional metric (positive or negative skewness) than just the variability (non-directional). 


[I separately ran models replacing t_med with t_var (see graphs below): for birds no environmental effects due to $t_{var}$, for fish I found increasing variability decreases richness.]


```{r model_psem_t_var_with_meancentering, echo=F, cache=T, message=F, cache.extra=list(mtime(here("Results/stability_metric_and_env_all.csv")), mtime(here("R/plot_psem.R")))}

library(tidyverse)
library(lme4)
library(piecewiseSEM)
source(here("R/plot_psem.R"))

mean_centering<-TRUE
resloc<-here("Results/res_Prelim_Report/")

sm_all<-read.csv(here("Results/stability_metric_and_env_all.csv"))
sm_all$UID<-paste(sm_all$source,sm_all$STUDY_ID,sep="_")
sm_all$A<-sm_all$L+abs(sm_all$U) # total asymmetry
sm_all<-sm_all%>%dplyr::rename(
  stability=iCValt,
  VR=phi_LdM,
  R=nsp)

sm_all$TAXA<-as.factor(sm_all$TAXA)

#---------------- for birds -----------------------
taxa<-"birds"
sm_all_eachtaxa<-sm_all%>%filter(TAXA==taxa)

############ want rescaling? #################
mydat_scaled<-sm_all_eachtaxa
mydat_scaled$stability<-as.numeric(scale(mydat_scaled$stability,
                                         center=mean_centering,scale=T))
mydat_scaled$R<-as.numeric(scale(mydat_scaled$R,
                                 center=mean_centering,scale=T))
mydat_scaled$VR<- as.numeric(scale(mydat_scaled$VR,
                                   center=mean_centering,scale=T))
mydat_scaled$A<- as.numeric(scale(mydat_scaled$A,
                                  center=mean_centering,scale=T))

mydat_scaled$t_med<-as.numeric(scale(mydat_scaled$t_med,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_med<-as.numeric(scale(mydat_scaled$tmax_med,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_med<-as.numeric(scale(mydat_scaled$tmin_med,
                                        center=mean_centering,scale=T))

mydat_scaled$t_skw<-as.numeric(scale(mydat_scaled$t_skw,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_skw<-as.numeric(scale(mydat_scaled$tmax_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_skw<-as.numeric(scale(mydat_scaled$tmin_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$t_var<-as.numeric(scale(mydat_scaled$t_var,
                                     center=mean_centering,scale=T))
mydat_scaled$trend_t_tau<-as.numeric(scale(mydat_scaled$trend_t_tau,
                                           center=mean_centering,scale=T))
mydat_scaled$t.sens.slope<-as.numeric(scale(mydat_scaled$t.sens.slope,
                                            center=mean_centering,scale=T))
mydat_scaled$t.lm.slope<-as.numeric(scale(mydat_scaled$t.lm.slope,
                                          center=mean_centering,scale=T))
#---  


dat<-mydat_scaled
n<-nrow(dat)
model_psem<-piecewiseSEM::psem(
  lmer(VR ~ R+t_var+t.sens.slope+(1|UID),data=dat),
  lmer(A ~ R+t.sens.slope+t_skw+(1|UID),data=dat),
  lmer(R~t_var+t.sens.slope+(1|UID),data=dat),
  lmer(stability ~ (R*t_var)+VR+A+t.sens.slope+t_skw+(1|UID), data=dat))
cc<-coefs(model_psem)
plot_psem(n,taxa,cc,layout="circle")
#print(summary(model_psem))
#---------------- for fish -----------------------
taxa<-"fish"
sm_all_eachtaxa<-sm_all%>%filter(TAXA==taxa)

############ want rescaling? #################
mydat_scaled<-sm_all_eachtaxa
mydat_scaled$stability<-as.numeric(scale(mydat_scaled$stability,
                                         center=mean_centering,scale=T))
mydat_scaled$R<-as.numeric(scale(mydat_scaled$R,
                                 center=mean_centering,scale=T))
mydat_scaled$VR<- as.numeric(scale(mydat_scaled$VR,
                                   center=mean_centering,scale=T))
mydat_scaled$A<- as.numeric(scale(mydat_scaled$A,
                                  center=mean_centering,scale=T))

mydat_scaled$t_med<-as.numeric(scale(mydat_scaled$t_med,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_med<-as.numeric(scale(mydat_scaled$tmax_med,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_med<-as.numeric(scale(mydat_scaled$tmin_med,
                                        center=mean_centering,scale=T))

mydat_scaled$t_skw<-as.numeric(scale(mydat_scaled$t_skw,
                                     center=mean_centering,scale=T))
mydat_scaled$tmax_skw<-as.numeric(scale(mydat_scaled$tmax_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$tmin_skw<-as.numeric(scale(mydat_scaled$tmin_skw,
                                        center=mean_centering,scale=T))
mydat_scaled$t_var<-as.numeric(scale(mydat_scaled$t_var,
                                     center=mean_centering,scale=T))
mydat_scaled$trend_t_tau<-as.numeric(scale(mydat_scaled$trend_t_tau,
                                           center=mean_centering,scale=T))
mydat_scaled$t.sens.slope<-as.numeric(scale(mydat_scaled$t.sens.slope,
                                            center=mean_centering,scale=T))
mydat_scaled$t.lm.slope<-as.numeric(scale(mydat_scaled$t.lm.slope,
                                          center=mean_centering,scale=T))
#---  
dat<-mydat_scaled
n<-nrow(dat)
model_psem<-piecewiseSEM::psem(
  lmer(VR ~ R+t_var+t.sens.slope+(1|UID),data=dat),
  lmer(A ~ R+t.sens.slope+t_skw+(1|UID),data=dat),
  lmer(R~t_var+t.sens.slope+(1|UID),data=dat),
  lmer(stability ~ (R*t_var)+VR+A+t.sens.slope+t_skw+(1|UID), data=dat))
cc<-coefs(model_psem)
plot_psem(n,taxa,cc,layout="circle")
#print(summary(model_psem))
```

-->

# Discussion
